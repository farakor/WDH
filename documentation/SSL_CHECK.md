# 🔒 SSL Certificate Monitoring

## Обзор

Система автоматически проверяет SSL сертификаты всех HTTPS сайтов и предупреждает о проблемах или истекающих сертификатах.

## 🎯 Функционал

### Автоматическая проверка

- ✅ Проверяется при каждом мониторинге (каждую минуту для активных сайтов)
- ✅ Только для HTTPS сайтов (HTTP сайты пропускаются)
- ✅ Результаты сохраняются в базу данных
- ✅ История всех проверок доступна

### Проверяемые параметры

1. **Валидность сертификата** - доверенный ли сертификат
2. **Срок действия** - дата истечения сертификата
3. **Дни до истечения** - количество дней до истечения
4. **Издатель** - кто выдал сертификат (Let's Encrypt, DigiCert, и т.д.)

## 📊 Уровни предупреждений

| Статус           | Дни до истечения | Цвет         | Badge          | Описание              |
| ---------------- | ---------------- | ------------ | -------------- | --------------------- |
| ✅ **Норма**     | > 30 дней        | 🟢 Зеленый   | -              | Всё хорошо            |
| ⚠️ **Warning**   | 8-30 дней        | 🟠 Оранжевый | `SSL: Xд`      | Планируйте обновление |
| 🚨 **Critical**  | 0-7 дней         | 🔴 Красный   | `SSL: Xд`      | Срочно обновите!      |
| ❌ **Невалиден** | -                | 🔴 Красный   | `SSL Проблема` | Немедленно исправьте  |

## 🖥️ Отображение

### Dashboard

На главной странице отображаются SSL индикаторы для каждого сайта:

```
Яндекс                      [🟢 Онлайн] [🔴 Сертификат истек]  ← Невалидный сертификат
https://ya.ru

Google                      [🟢 Онлайн] [🟠 SSL: 25д]          ← Истекает через 25 дней
https://google.com

Example                     [🔴 Офлайн] [🔴 SSL сертификат отсутствует]  ← Сертификат отсутствует
https://example.com
```

### Страница списка сайтов

В таблице сайтов рядом со статусом отображаются SSL badges:

```
┌─────────────────────────────────────────────────────┐
│ Сайт              │ Статус                          │
├─────────────────────────────────────────────────────┤
│ example.com       │ [Онлайн] [SSL: 28д]             │  ← Истекает
│ test.com          │ [Онлайн] [Сертификат истек]     │  ← Невалиден
│ nossl.com         │ [Онлайн] [SSL сертификат отсутствует] │  ← Отсутствует
│ valid.com         │ [Онлайн]                        │  ← Валидный (>30д)
└─────────────────────────────────────────────────────┘
```

**Логика отображения SSL badges:**

| Условие                              | Badge                       | Цвет      | Описание              |
| ------------------------------------ | --------------------------- | --------- | --------------------- |
| `sslValid === false`                 | `🔴 Сертификат истек` и др. | Красный   | Конкретная ошибка SSL |
| `errorMessage.includes('SSL')`       | `🔴 Сертификат истек` и др. | Красный   | Конкретная ошибка SSL |
| `sslValid === true && daysLeft ≤ 7`  | `🔴 SSL: Xд`                | Красный   | Критично - истекает   |
| `sslValid === true && daysLeft ≤ 30` | `🟠 SSL: Xд`                | Оранжевый | Предупреждение        |
| `sslValid === true && daysLeft > 30` | -                           | -         | Всё в порядке         |

**Примечание:** При невалидном SSL сертификате отображается конкретный текст ошибки из backend:

- "Сертификат истек" - когда срок действия сертификата истек
- "Сертификат не доверенный" - когда сертификат self-signed или от неизвестного CA
- "Сертификат еще не действителен" - когда дата начала действия еще не наступила
- "SSL сертификат отсутствует" - когда HTTPS сайт не имеет SSL сертификата

### Детальная страница сайта

Полная информация о SSL сертификате:

```
┌─────────────────────────────────────────────────┐
│  🛡️ SSL Сертификат                              │
├─────────────────────────────────────────────────┤
│  ✅ Статус: Валидный                            │
│  ⏰ Дней до истечения: 87 дней                  │
│  📅 Срок действия до: 01.01.2026                │
├─────────────────────────────────────────────────┤
│  🏢 Издатель сертификата                        │
│     Let's Encrypt                               │
└─────────────────────────────────────────────────┘
```

**Если SSL сертификат отсутствует:**

```
┌─────────────────────────────────────────────────┐
│  ⚠️ Проблема с SSL сертификатом                 │
│     SSL сертификат отсутствует                  │
└─────────────────────────────────────────────────┘
```

При истечении < 30 дней показывается предупреждение:

```
⚠️ Внимание! SSL сертификат истекает через 15 дней.
   Рекомендуется обновить сертификат как можно скорее.
```

## 🔧 Техническая реализация

### Backend (`ssl.service.ts`)

```typescript
interface SSLInfo {
  valid: boolean; // Валидность сертификата
  expiresAt: Date | null; // Дата истечения
  issuer: string | null; // Издатель
  daysLeft: number | null; // Дней до истечения
  error: string | null; // Описание ошибки (если есть)
}
```

**Логика проверки:**

1. Проверяем что URL использует HTTPS
2. Устанавливаем HTTPS соединение
3. Получаем сертификат через `getPeerCertificate()`
4. Проверяем срок действия (`valid_from`, `valid_to`)
5. Проверяем доверенность (`authorized`)
6. Вычисляем дни до истечения
7. Возвращаем структурированные данные
8. **При ошибках подключения:** анализируем код ошибки и сообщение для определения SSL проблем (`CERT_HAS_EXPIRED`, `DEPTH_ZERO_SELF_SIGNED_CERT`, и т.д.)

### Database Schema

```prisma
model StatusCheck {
  id              String      @id @default(uuid())
  // ... другие поля ...

  // SSL информация
  sslValid        Boolean?    // Валидность SSL сертификата
  sslExpiresAt    DateTime?   // Дата истечения сертификата
  sslIssuer       String?     // Издатель сертификата
  sslDaysLeft     Int?        // Дней до истечения
}
```

### Frontend Components

**Иконки (Lucide React):**

- `Shield` - Общая иконка SSL
- `ShieldCheck` - Валидный сертификат (зеленый)
- `ShieldAlert` - Невалидный сертификат (красный)
- `AlertTriangle` - Предупреждение об истечении (оранжевый/красный)
- `Clock` - Время до истечения

## 📈 Примеры использования

### Мониторинг корпоративных сайтов

```
company.com      [Онлайн] ✅ SSL: 89 дней
api.company.com  [Онлайн] ⚠️ SSL: 25 дней  ← Планируйте обновление
old.company.com  [Онлайн] 🚨 SSL: 3 дня    ← СРОЧНО!
```

### История проверок

Все SSL проверки сохраняются в базу данных, что позволяет:

- Отслеживать изменения сертификатов
- Видеть когда сертификат был обновлен
- Анализировать проблемы в прошлом

## 🔍 Обработка ошибок

### Типы SSL ошибок

| Ошибка                                 | Код ошибки / Описание          | Отображение                             |
| -------------------------------------- | ------------------------------ | --------------------------------------- |
| **Сертификат отсутствует**             | Нет SSL на HTTPS сайте         | `🔴 SSL сертификат отсутствует`         |
| **Сертификат истек**                   | `CERT_HAS_EXPIRED`             | `🔴 Сертификат истек`                   |
| **Сертификат не действителен**         | `valid_from > now`             | `🔴 Сертификат еще не действителен`     |
| **Не доверенный сертификат**           | `DEPTH_ZERO_SELF_SIGNED_CERT`  | `🔴 Сертификат не доверенный`           |
| **Сертификат не соответствует домену** | `ERR_TLS_CERT_ALTNAME_INVALID` | `🔴 Сертификат не соответствует домену` |
| **Общая проблема с сертификатом**      | Другие ошибки с "certificate"  | `🔴 Проблема с сертификатом`            |
| **Общая SSL ошибка**                   | Другие SSL/TLS ошибки          | `🔴 SSL ошибка`                         |
| **Timeout**                            | Не удалось получить сертификат | Статус "Офлайн", без SSL badge          |

**Особенности отображения:**

- Если сертификата вообще нет - показывается явное сообщение: **"SSL сертификат отсутствует"**
- Ошибки SSL отображаются отдельным блоком на странице деталей с иконкой 🛡️
- В списке сайтов показывается красный badge с **конкретной ошибкой** (например, "Сертификат истек")
- В сообщении об ошибке четко указывается причина проблемы
- **Важно:** SSL ошибки определяются даже в случае полного провала подключения (catch блок), проверяя коды ошибок `CERT_HAS_EXPIRED`, `DEPTH_ZERO_SELF_SIGNED_CERT` и др.

### Для HTTP сайтов

HTTP сайты не проверяются на SSL, все SSL поля будут `null`.

## 🎨 UI/UX Features

### Цветовая индикация

- **Зеленый** (`text-green-600`) - Всё в порядке (> 30 дней)
- **Оранжевый** (`text-orange-600`) - Внимание (8-30 дней)
- **Красный** (`text-red-600`) - Критично (< 7 дней или невалиден)

### Badges

```jsx
// SSL проблема (невалидный) - отображается конкретная ошибка
<span className="badge-red">
  <ShieldAlert /> Сертификат истек
</span>

// SSL истекает (оранжевый)
<span className="badge-orange">
  <AlertTriangle /> SSL: 25д
</span>

// SSL истекает критично (красный)
<span className="badge-red">
  <AlertTriangle /> SSL: 3д
</span>
```

### Адаптивность

- На десктопе показывается полная информация
- На мобильных устройствах badges переносятся на новую строку (`flex-wrap`)
- Иконки масштабируются (`w-3 h-3`, `w-5 h-5`, `w-6 h-6`)

## 🚀 Рекомендации

### Для администраторов

1. **Регулярно проверяйте Dashboard** - следите за оранжевыми и красными badges
2. **Обновляйте сертификаты заранее** - не ждите последнего дня
3. **Используйте автоматическое обновление** - Let's Encrypt + Certbot
4. **Проверяйте детальную информацию** - кликайте на сайт для подробностей

### Настройка автоматического обновления

Для Let's Encrypt:

```bash
# Установка Certbot
sudo apt install certbot python3-certbot-nginx

# Автоматическое обновление
sudo certbot renew --dry-run
```

### Лучшие практики

- ✅ Обновляйте сертификаты за 30+ дней до истечения
- ✅ Используйте доверенные CA (Let's Encrypt, DigiCert, и т.д.)
- ✅ Настройте автоматическое обновление
- ✅ Тестируйте сертификаты после обновления
- ✅ Храните резервные копии закрытых ключей

## 📝 API Endpoints

### Получение информации о SSL

```
GET /api/websites/:id/status-checks?limit=1
```

Response:

```json
{
  "id": "uuid",
  "status": "ONLINE",
  "sslValid": true,
  "sslExpiresAt": "2026-01-01T00:00:00Z",
  "sslIssuer": "Let's Encrypt",
  "sslDaysLeft": 87,
  "checkedAt": "2025-10-04T19:30:00Z"
}
```

## 🎯 Roadmap

### Планируемые улучшения

- [ ] Email уведомления об истекающих сертификатах
- [ ] Telegram уведомления об SSL проблемах
- [ ] График истечения сертификатов
- [ ] Массовая проверка SSL всех сайтов
- [ ] Экспорт отчета по SSL статусу

## 📞 Поддержка

При возникновении проблем проверьте:

1. Сайт использует HTTPS
2. Сертификат установлен корректно
3. Backend имеет доступ к сайту
4. Порт 443 доступен

---

**Разработано:** 2025  
**Версия:** 1.0.0  
**Технологии:** Node.js, TypeScript, Prisma, React, Lucide Icons
